#define MAX1 32
#define MAX2 MAX1
#include <stdio.h>
#include <x86intrin.h>
#include <print.h>


inline void _mm256_shuffle_swap_epi16(__m256i a, __m256i b, const __m256i shuffle, const  __m256i swap)
{
    __m256i a_shuffled = _mm256_shuffle_epi8(a, shuffle);   printf("       1a: "); printVeci16(a);
    __m256i b_shuffled = _mm256_shuffle_epi8(b, shuffle);   printf("       1b: "); printVeci16(b);
    a = _mm256_blendv_epi8(a_shuffled, b_shuffled, swap);	printf("       2a: "); printVeci16(a);
    b = _mm256_blendv_epi8(b_shuffled, a_shuffled, swap);   printf("       2b: "); printVeci16(b);
}


__m256i K0, K1;
inline __m256i Shuffle( __m256i value,  __m256i shuffle)
{
    return _mm256_or_si256(_mm256_shuffle_epi8(value, _mm256_add_epi8(shuffle, K0)), 
        _mm256_shuffle_epi8(_mm256_permute4x64_epi64(value, 0x4E), _mm256_add_epi8(shuffle, K1)));
}

int main()
{
	//__m256i shuffle  = _mm256_setr_epi16(0x0,0x0, 0x01,0x01, 0x02,0x02, 0x03,0x03, 0x04,0x04, 0x05,0x05, 0x06,0x06, 0x07,0x07);
	//__m256i swap     = _mm256_setr_epi16(0x01,0x01, 0x02,0x02, 0x03,0x03, 0x04,0x04, 0x05,0x05, 0x06,0x06, 0x07,0x07, 0x08,0x08);
	
	K0 = _mm256_setr_epi8(
    0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0);
    
    K1 = _mm256_setr_epi8(
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
    0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70);
    
	__m256i input_v1 = _mm256_set_epi16(16, 15, 14, 13, 12, 11, 10,  9,  8,  7,  6,  5,  4,  3,  2,  1);
	__m256i input_v2 = _mm256_set_epi16(32, 31, 30, 29, 28, 27, 26, 25, 24, 23, 22, 21, 20, 19, 18, 17);
	__m256i input_v3 = _mm256_set_epi16(48, 47, 46, 45, 44, 43, 42, 41, 40, 39, 38, 37, 36, 35, 34, 33);
	__m256i output_v1, output_v2, output_v3; 
	


	printf("  input_v1: "); printVeci16(input_v1);
	printf("  input_v2: "); printVeci16(input_v2);
	printf("  input_v3: "); printVeci16(input_v3);
	
	
	
	__m256i vec1, vec2, vec3, vec4, vec5, vec6, vec7, vec8, vec9;
	__m256i mask1 = _mm256_setr_epi8(0x00,0x01, 0xF0,0xF0, 0xF0,0xF0, 0x06,0x07, 0xF0, 0xF0, 0xF0, 0xF0, 0x0C, 0x0D, 0xF0,0xF0,    
									 0xF0,0xF0, 0x02,0x03, 0xF0,0xF0, 0xF0,0xF0, 0x08, 0x09, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,0xF0);
									 
	__m256i mask2 = _mm256_setr_epi8(0x02,0x03, 0xF0,0xF0, 0xF0,0xF0, 0x08,0x09, 0xF0, 0xF0, 0xF0, 0xF0, 0x0E, 0x0F, 0xF0,0xF0,    
									 0xF0,0xF0, 0x04,0x05, 0xF0,0xF0, 0xF0,0xF0, 0x0A, 0x0B, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,0xF0);
	__m256i mask4 = _mm256_setr_epi8(0xF0,0xF0, 0x00,0x01, 0xF0,0xF0, 0xF0,0xF0, 0x06,0x07, 0xF0, 0xF0, 0xF0, 0xF0, 0x0C, 0x0D,    
									 0xF0,0xF0, 0xF0,0xF0, 0x02,0x03, 0xF0,0xF0, 0xF0,0xF0, 0x08, 0x09, 0xF0, 0xF0, 0xF0, 0xF0);
	__m256i mask5 = _mm256_setr_epi8(0xF0,0xF0, 0x02,0x03, 0xF0,0xF0, 0xF0,0xF0, 0x08,0x09, 0xF0, 0xF0, 0xF0, 0xF0, 0x0E, 0x0F,    
									 0xF0,0xF0, 0xF0,0xF0, 0x04,0x05, 0xF0,0xF0, 0xF0,0xF0, 0x0A, 0x0B, 0xF0, 0xF0, 0xF0, 0xF0);							 
									 
	__m256i mask7 = _mm256_setr_epi8(0xF0,0xF0, 0xF0,0xF0, 0x04,0x05, 0xF0,0xF0, 0xF0,0xF0, 0x0A,0x0B, 0xF0, 0xF0, 0xF0, 0xF0,    
									 0x00,0x01, 0xF0,0xF0, 0xF0,0xF0, 0x06,0x07, 0xF0,0xF0, 0xF0, 0xF0, 0x0C, 0x0D, 0xF0, 0xF0);
									 
	__m256i mask8 = _mm256_setr_epi8(0xF0,0xF0, 0xF0,0xF0, 0x06,0x07, 0xF0,0xF0, 0xF0,0xF0, 0x0C,0x0D, 0xF0, 0xF0, 0xF0, 0xF0,    
									 0x02,0x03, 0xF0,0xF0, 0xF0,0xF0, 0x08,0x09, 0xF0,0xF0, 0xF0, 0xF0, 0x0E, 0x0F, 0xF0, 0xF0);
									 
	__m256i mask9 = _mm256_setr_epi8(0xF0,0xF0, 0xF0,0xF0, 0x04,0x05, 0xF0,0xF0, 0xF0,0xF0, 0x0A,0x0B, 0xF0, 0xF0, 0xF0, 0xF0,    
									 0x00,0x01, 0xF0,0xF0, 0xF0,0xF0, 0x06,0x07, 0xF0,0xF0, 0xF0,0xF0, 0x0C, 0x0D, 0xF0, 0xF0);
									 							 
	//for input_v1:								 
																
	vec1 = _mm256_shuffle_epi8(input_v1, mask1);  printf("     vec1: "); printVeci16(vec1);
	vec2 = _mm256_shuffle_epi8(input_v1, mask2);  printf("     vec2: "); printVeci16(vec2);
		
	input_v1 = _mm256_permutevar8x32_epi32( input_v1, _mm256_setr_epi32(1,2,3,4,5,6,7,0)); //printf("  input_v1: "); printVeci16(input_v1);
	vec3 = _mm256_shuffle_epi8(input_v1, mask1);  printf("     vec3: "); printVeci16(vec3);
	
	output_v1 = _mm256_add_epi16(vec1, _mm256_add_epi16(vec2, vec3));// printf(" output_v1: "); printVeci16(output_v1);
		
	//for Input_v2:									
																
	vec4 = _mm256_shuffle_epi8(input_v2, mask4);  printf("     vec4: "); printVeci16(vec4);
	vec5 = _mm256_shuffle_epi8(input_v2, mask5);  printf("     vec5: "); printVeci16(vec5);
	input_v2 = _mm256_permutevar8x32_epi32( input_v2, _mm256_setr_epi32(1,2,3,4,5,6,7,0));
	vec6 = _mm256_shuffle_epi8(input_v2, mask4);  printf("     vec6: "); printVeci16(vec6);
	
	output_v2 = _mm256_add_epi16(_mm256_add_epi16(output_v1, vec4), _mm256_add_epi16(vec5, vec6));// printf(" output_v2: "); printVeci16(output_v2);

	
	//for Input_v3:	

	vec9 = _mm256_shuffle_epi8(input_v3, mask9);  //printf("     vec9: "); printVeci16(vec9);
	
	input_v3 = _mm256_permutevar8x32_epi32( input_v3, _mm256_setr_epi32(7,0,1,2,3,4,5,6)); //printf("  input_v3: "); printVeci16(input_v3);
	
	vec7 = _mm256_shuffle_epi8(input_v3, mask7);  printf("     vec7: "); printVeci16(vec7);
	vec8 = _mm256_shuffle_epi8(input_v3, mask8);  printf("     vec8: "); printVeci16(vec8);
	
	output_v3 = _mm256_add_epi16(_mm256_add_epi16(output_v2, vec9), _mm256_add_epi16(vec7, vec8));// printf(" output_v2: "); printVeci16(output_v2);

	 printf("     vec9: "); printVeci16(vec9);
	
	printf(" output_v2: "); printVeci16(output_v3);
	
	
	

	return 0;
}
